<div class="certificate-generator">
  <h1>Generador de Certificados Automático</h1>

  <!-- Navegación de pasos -->
  <div class="steps-nav">
    <div class="step" [class.active]="currentStep === 1">1. Datos</div>
    <div class="step" [class.active]="currentStep === 2">2. Posicionamiento</div>
    <div class="step" [class.active]="currentStep === 3">3. Vista previa / Generar</div>
  </div>

  <!-- Paso 1: Subir Excel -->
  <div class="step-content" [class.hidden-step]="currentStep !== 1">
    <h2>Paso 1: Subir Archivo Excel / CSV</h2>
    <p>Sube un archivo .xlsx, .xls o .csv. La primera fila debe contener los encabezados (nombres de campos).</p>
    <input type="file" (change)="onExcelSelected($event)" accept=".xlsx,.xls,.csv" class="file-input">
    <div *ngIf="excelData.length > 0" class="excel-preview">
      <h4>Vista previa de datos:</h4>
      <table class="data-table">
        <thead><tr><th *ngFor="let header of excelHeaders">{{ header }}</th></tr></thead>
        <tbody>
          <tr *ngFor="let row of excelData.slice(0, 3)">
            <td *ngFor="let header of excelHeaders">{{ row[header] }}</td>
          </tr>
        </tbody>
      </table>
      <p *ngIf="excelData.length > 3">...y {{ excelData.length - 3 }} filas más</p>
    </div>
    <div class="wizard-actions">
      <button class="generate-btn" (click)="goToStep(2)" [disabled]="excelHeaders.length===0">Siguiente ➜</button>
    </div>
  </div>

  <!-- Paso 2: Subir Imagen y Posicionar -->
  <div class="step-content positioning-step" [class.hidden-step]="currentStep !== 2">
    <h2>Paso 2: Subir Imagen y Posicionar Campos</h2>
    <p>Sube la imagen de la plantilla y arrastra los campos (primera fila de datos) sobre el certificado.</p>
    <input type="file" (change)="onImageSelected($event)" accept="image/*" class="file-input">
    <div *ngIf="!selectedImage" class="hint-box">Aún no has subido una imagen.</div>
    <div class="toggle-real-data" *ngIf="selectedImage" style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap;margin:.5rem 0 1rem;">
      <label><input type="checkbox" [(ngModel)]="showRealData" (change)="redrawCanvas()"> Mostrar valores reales</label>
      <button *ngIf="selectedImage" class="mini secondary" (click)="toggleFullscreen()">Pantalla completa</button>
    </div>
    <div *ngIf="selectedImage" class="canvas-shell always-open">
      <div class="canvas-stage">
        <canvas #fabricCanvas></canvas>
      </div>
      <aside class="side-panel" *ngIf="overlayMode">
        <div class="side-panel-inner">
          <h3>Edición</h3>
          <div class="accordion">
            <div class="acc-item" *ngFor="let header of excelHeaders" [class.expanded]="expandedPanels[header]">
              <button type="button" class="acc-header" (click)="toggleFieldPanel(header)">
                <span>{{ header }}</span>
                <span class="chevron">{{ expandedPanels[header] ? '▾' : '▸' }}</span>
              </button>
              <div class="acc-body" *ngIf="expandedPanels[header]">
                <div class="acc-row actions">
                  <button (click)="addTextField(header)" class="mini primary" [class.active]="selectedFieldName===header">{{ selectedFieldName===header? '✓ Seleccionado':'Seleccionar' }}</button>
                  <button class="mini" (click)="centerField(header,'h')" title="Centrar horizontal">↔</button>
                  <button class="mini" (click)="centerField(header,'v')" title="Centrar vertical">↕</button>
                </div>
                <div class="acc-grid">
                  <label>Size<input type="number" [(ngModel)]="fieldSettings[header].fontSize" min="8" max="180" (change)="redrawCanvas()"></label>
                  <label>Color<input type="color" [(ngModel)]="fieldSettings[header].color" (change)="redrawCanvas()"></label>
                  <label>X<input type="number" [(ngModel)]="fieldSettings[header].x" (change)="redrawCanvas()"></label>
                  <label>Y<input type="number" [(ngModel)]="fieldSettings[header].y" (change)="redrawCanvas()"></label>
                  <label style="grid-column:1/3">Fuente<select [(ngModel)]="fieldSettings[header].fontFamily" (change)="redrawCanvas()">
                    <option *ngFor="let f of availableFonts" [value]="f">{{ f }}</option>
                  </select></label>
                </div>
              </div>
            </div>
            <!-- Opciones en su propio acordeón -->
            <div class="acc-item" [class.expanded]="expandedPanels['__opts']">
              <button type="button" class="acc-header" (click)="toggleFieldPanel('__opts')">
                <span>Opciones</span>
                <span class="chevron">{{ expandedPanels['__opts'] ? '▾' : '▸' }}</span>
              </button>
              <div class="acc-body" *ngIf="expandedPanels['__opts']">
                <div class="options-grid">
                  <label><input type="checkbox" [(ngModel)]="showGrid" (change)="redrawCanvas()"> Grid</label>
                  <label><input type="checkbox" [(ngModel)]="snapToGrid"> Snap</label>
                  <label>Grid <input type="number" [(ngModel)]="gridSize" min="5" max="100" (change)="redrawCanvas()"></label>
                  <label><input type="checkbox" [(ngModel)]="showAlignmentGuides" (change)="redrawCanvas()"> Guías</label>
                  <label>Tol <input type="number" [(ngModel)]="alignmentThreshold" min="1" max="30"></label>
                  <label><input type="checkbox" [(ngModel)]="showGuideDistances" (change)="redrawCanvas()"> Dist</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>
    <div class="wizard-actions">
      <button class="preview-btn" (click)="goToStep(1)">⬅ Volver</button>
      <button class="generate-btn" (click)="goToStep(3)" [disabled]="!selectedImage">Siguiente ➜</button>
    </div>
  </div>

  <!-- Paso 3: Vista previa y Generar -->
  <div class="step-content" [class.hidden-step]="currentStep !== 3">
    <h2>Paso 3: Vista Previa y Generación</h2>
    <p>Revisa la vista previa. Si es correcta, genera todos los certificados.</p>
    <div class="preview-flex">
      <div class="preview-main">
        <div class="preview-section" *ngIf="previewUrl">
          <img [src]="previewUrl" alt="Vista previa" class="certificate-preview">
        </div>
        <div *ngIf="!previewUrl" class="hint-box">Generando vista previa...</div>
      </div>
      <div class="preview-side">
        <div class="group-box">
          <label>Columna para agrupar:<br>
            <select [(ngModel)]="groupByColumn">
              <option value="">(Sin agrupación)</option>
              <option *ngFor="let h of excelHeaders" [value]="h">{{ h }}</option>
            </select>
          </label>
        </div>
      </div>
    </div>
    <div class="wizard-actions">
      <button class="preview-btn" (click)="goToStep(2)">⬅ Volver</button>
      <button class="preview-btn" (click)="previewCertificate()" [disabled]="isGenerating">Actualizar Vista Previa</button>
      <button class="generate-btn" (click)="generateAllCertificates()" [disabled]="isGenerating">
        {{ isGenerating ? 'Generando...' : 'Generar ZIP' }}
      </button>
    </div>
    <div *ngIf="isGenerating" class="progress-info">
      <p>⏳ Generando certificados... {{ progressPercent }}%</p>
      <div style="background:#eee;border-radius:6px;overflow:hidden;height:14px;margin-top:8px;">
        <div [style.width]="progressPercent + '%'" style="background:#28a745;height:100%;transition:width .3s ease"></div>
      </div>
    </div>
  </div>
</div>
